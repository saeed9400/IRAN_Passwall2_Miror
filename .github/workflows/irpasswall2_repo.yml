name: irpasswall2_repo

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  sync-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq unzip curl coreutils findutils

      - name: Get latest release info
        id: get-release
        run: |
          curl -s -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/Openwrt-Passwall/openwrt-passwall2/releases/latest > release.json
          
          VERSION=$(jq -r '.tag_name // "unknown"' release.json)
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          
          ASSET_COUNT=$(jq '.assets | length' release.json)
          echo "Found $ASSET_COUNT assets"

      - name: Prepare repository structure
        run: |
          mkdir -p packages

      - name: Download and organize assets
        run: |
          TARGET_BASE="packages"
          echo "Target base: $TARGET_BASE"
          
          # فقط فایل‌های .ipk و .zip مورد نظر را استخراج می‌کنیم
          jq -r '
            .assets[]
            | select(.name | test("\\.ipk$|passwall_packages_apk_.*\\.zip$"; "i"))
            | [.name, .browser_download_url] | @tsv
          ' release.json > assets_list.txt
          
          echo "Assets to process:"
          cat assets_list.txt || echo "(empty)"
          
          while IFS=$'\t' read -r NAME URL; do
            [ -z "$NAME" ] && continue
            
            echo "→ $NAME"
            
            # فایل‌های ipk ساده
            if [[ "$NAME" == *.ipk ]]; then
              # حدس معماری از نام فایل (یا می‌توانید دستی مپ کنید)
              if [[ $NAME =~ _([a-z0-9_]+)\.ipk$ ]]; then
                ARCH="${BASH_REMATCH[1]}"
              else
                ARCH="unknown"
              fi
              
              mkdir -p "$TARGET_BASE/$ARCH"
              curl -L --fail -o "$TARGET_BASE/$ARCH/$NAME" "$URL" && echo "OK" || echo "Failed"
            fi
            
            # فایل zip مربوط به apk (اندروید) یا ipkهای چندتایی
            if [[ "$NAME" == passwall_packages_apk_*.zip ]]; then
              curl -L --fail -o temp.zip "$URL" || continue
              
              unzip -o -q temp.zip -d temp_extract || { rm -f temp.zip; continue; }
              
              # فرض می‌کنیم داخل زیپ، فایل‌ها با نام معماری هستند یا باید تشخیص دهیم
              # اگر ساختار زیپ مشخص است → اینجا تنظیم کنید
              # مثال ساده: همه را در unknown می‌گذاریم یا از نام زیپ معماری استخراج می‌کنیم
              
              if [[ $NAME =~ passwall_packages_apk_([a-z0-9_]+)_ ]]; then
                ARCH="${BASH_REMATCH[1]}"
              else
                ARCH="unknown"
              fi
              
              mkdir -p "$TARGET_BASE/$ARCH"
              find temp_extract -type f -name "*.ipk" -exec mv {} "$TARGET_BASE/$ARCH/" \;
              
              rm -rf temp_extract temp.zip
              echo "Extracted to $TARGET_BASE/$ARCH"
            fi
          done < assets_list.txt

      - name: Generate Packages index
        run: |
          # نصب ابزار لازم برای ساخت ایندکس
          sudo apt-get install -y libarchive-tools coreutils
          
          cd packages
          
          # ساخت فایل Packages برای همه معماری‌ها
          for arch_dir in */; do
            if [ -d "$arch_dir" ]; then
              arch=${arch_dir%/}
              echo "Generating Packages for $arch ..."
              # استفاده از اسکریپت ساده یا مستقیم
              find "$arch_dir" -name "*.ipk" | while read -r pkg; do
                # استخراج اطلاعات با tar + control
                control=$(tar -xOf "$pkg" ./control.tar.gz | gunzip -c | tar -xOf - ./control 2>/dev/null)
                if [ -n "$control" ]; then
                  echo "$control"
                  echo "Filename: $pkg"
                  echo "Size: $(stat -c %s "$pkg")"
                  echo "MD5Sum: $(md5sum "$pkg" | cut -d' ' -f1)"
                  echo "SHA256sum: $(sha256sum "$pkg" | cut -d' ' -f1)"
                  echo ""
                fi
              done > "../Packages.tmp"
            fi
          done
          
          # ادغام همه در یک فایل Packages
          cat ../Packages.tmp > ../Packages
          rm -f ../Packages.tmp
          
          # فشرده‌سازی
          gzip -9 -c ../Packages > ../Packages.gz

      - name: Show final structure (debug)
        run: |
          find packages -type f | sort
          du -sh packages/* 2>/dev/null || true
          ls -lh Packages* || true

      - name: Commit and push changes
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          git add packages/ Packages* key-build.pub 2>/dev/null || true
          
          if git diff --staged --quiet; then
            echo "No changes"
          else
            git commit -m "Auto mirror Passwall2 latest release: ${{ env.VERSION }}"
            git push || echo "Push failed (maybe protected branch)"
          fi