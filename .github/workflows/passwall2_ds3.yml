name: passwall2 ds3

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # ูุฑ 6 ุณุงุนุช

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup tools
      run: |
        sudo apt-get update
        sudo apt-get install -y curl jq wget unzip
    
    - name: Discover latest release
      id: discover
      run: |
        echo "๐ Discovering latest release..."
        
        API_URL="https://api.github.com/repos/Openwrt-Passwall/openwrt-passwall2/releases/latest"
        RESPONSE=$(curl -s "$API_URL")
        
        # ุงุณุชุฎุฑุงุฌ ูุณุฎู
        VERSION=$(echo "$RESPONSE" | jq -r '.tag_name')
        echo "๐ฆ Version found: $VERSION"
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        
        # ุงุณุชุฎุฑุงุฌ ุชูุงู ูุงูโูุง ู ููฺฉโูุง
        echo "$RESPONSE" | jq -r '.assets[] | "\(.name)|\(.browser_download_url)"' > file_list.txt
        
        COUNT=$(wc -l < file_list.txt)
        echo "๐ Found $COUNT files"
        echo "COUNT=$COUNT" >> $GITHUB_ENV
        
        # ููุงุด ูุณุช
        echo "๐ File list:"
        cat file_list.txt
    
    - name: Create version folder
      run: |
        echo "๐ Creating folder for version: $VERSION"
        rm -rf "IR_Passwall2_M/$VERSION"
        mkdir -p "IR_Passwall2_M/$VERSION"
    
    - name: Process files intelligently
      run: |
        VERSION="${{ env.VERSION }}"
        cd "IR_Passwall2_M/$VERSION"
        
        echo "โ๏ธ Processing files..."
        
        # ุดูุงุฑูุฏูโูุง
        APK_COUNT=0
        IPK_COUNT=0
        ZIP_COUNT=0
        SKIP_COUNT=0
        
        # ุฎูุงูุฏู ุงุฒ ูุงู ูุณุช
        while IFS='|' read -r FILENAME DOWNLOAD_URL; do
          echo ""
          echo "โก๏ธ Processing: $FILENAME"
          
          # ุดุฑุท ฑ: ุฑุฏ ฺฉุฑุฏู source code
          if [[ "$FILENAME" == *"Source code"* ]]; then
            echo "   โญ๏ธ Skipping (source code)"
            ((SKIP_COUNT++))
            continue
          fi
          
          # ุดุฑุท ฒ: ุฑุฏ ฺฉุฑุฏู ูุงูโูุง tar.gz
          if [[ "$FILENAME" == *.tar.gz ]]; then
            echo "   โญ๏ธ Skipping (.tar.gz file)"
            ((SKIP_COUNT++))
            continue
          fi
          
          # ุฏุงูููุฏ ูุงู
          echo "   ๐ฅ Downloading..."
          wget -q -O "$FILENAME" "$DOWNLOAD_URL"
          
          if [ $? -ne 0 ]; then
            echo "   โ Download failed!"
            rm -f "$FILENAME"
            continue
          fi
          
          FILE_SIZE=$(stat -f%z "$FILENAME" 2>/dev/null || stat -c%s "$FILENAME")
          echo "   โ Downloaded ($((FILE_SIZE/1024)) KB)"
          
          # ุดุฑุท ณ: ุงฺฏุฑ ูุงู APK ุง IPK ูุณุชุ ฺฉูพ ฺฉู
          if [[ "$FILENAME" == *.apk ]]; then
            echo "   ๐ฆ Keeping APK file"
            ((APK_COUNT++))
            
          elif [[ "$FILENAME" == *.ipk ]]; then
            echo "   ๐ฆ Keeping IPK file"
            ((IPK_COUNT++))
          
          # ุดุฑุท ด: ุงฺฏุฑ ูุงู ZIP ูุณุชุ ุงฺฉุณุชุฑฺฉุช ฺฉู
          elif [[ "$FILENAME" == *.zip ]]; then
            echo "   ๐๏ธ Extracting ZIP file"
            
            # ุงุณุชุฎุฑุงุฌ ุงุทูุงุนุงุช ูุนูุงุฑ ุงุฒ ูุงู ูุงู
            if [[ "$FILENAME" =~ passwall_packages_apk_(.+)\.zip$ ]]; then
              ARCH_INFO="${BASH_REMATCH[1]}"
              
              # ุชุดุฎุต ูุนูุงุฑ ู ุฒุฑูุนูุงุฑ
              if [[ "$ARCH_INFO" =~ ^([a-zA-Z0-9]+)_(.+)$ ]]; then
                ARCH="${BASH_REMATCH[1]}"
                SUBARCH="${BASH_REMATCH[2]}"
                
                echo "   ๐๏ธ Architecture: $ARCH/$SUBARCH"
                
                # ุงุฌุงุฏ ูพูุดูโูุง
                mkdir -p "$ARCH/$SUBARCH"
                
                # ุงฺฉุณุชุฑฺฉุช
                unzip -q -o "$FILENAME" -d "$ARCH/$SUBARCH"
                
                EXTRACTED_FILES=$(find "$ARCH/$SUBARCH" -type f | wc -l)
                echo "   โ Extracted $EXTRACTED_FILES files"
                
                # ุญุฐู ูุงู ุฒูพ ุงุตู
                rm "$FILENAME"
                
                ((ZIP_COUNT++))
              else
                echo "   โ๏ธ Could not parse architecture from filename"
                rm "$FILENAME"
              fi
            else
              echo "   โ๏ธ Not a passwall packages ZIP, deleting"
              rm "$FILENAME"
            fi
          
          # ุดุฑุท ต: ุณุงุฑ ูุงูโูุง ุฑู ุญุฐู ฺฉู
          else
            echo "   ๐๏ธ Deleting unknown file type"
            rm "$FILENAME"
          fi
          
        done < ../../file_list.txt
        
        # ุฎูุงุตู
        echo ""
        echo "๐ Processing Summary:"
        echo "======================"
        echo "APK files kept: $APK_COUNT"
        echo "IPK files kept: $IPK_COUNT"
        echo "ZIP files extracted: $ZIP_COUNT"
        echo "Files skipped: $SKIP_COUNT"
        echo "Total processed: $((APK_COUNT + IPK_COUNT + ZIP_COUNT + SKIP_COUNT))"
    
    - name: Commit changes
      run: |
        echo "๐พ Committing changes..."
        
        git config user.name "GitHub Actions Bot"
        git config user.email "actions@github.com"
        
        # ุจุฑุฑุณ ุชุบุฑุงุช
        git status
        
        # ุงฺฏุฑ ุชุบุฑ ูุฌูุฏ ุฏุงุฑู
        if [[ -n "$(git status --porcelain)" ]]; then
          echo "๐ Changes detected, committing..."
          git add .
          git commit -m "๐ค Auto-sync Passwall2 v${{ env.VERSION }} [$(date +'%Y-%m-%d %H:%M')]"
          git push
          echo "โ Changes pushed successfully"
        else
          echo "โน๏ธ No changes to commit"
        fi
    
    - name: Create report
      if: always()
      run: |
        echo "## ๐ Auto Sync Report" >> $GITHUB_STEP_SUMMARY
        echo "**Version:** ${{ env.VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "**Time:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** โ Success" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ๐ Directory Structure:" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        find "IR_Passwall2_M/${{ env.VERSION }}" -type f | head -30 >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "No files yet" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY