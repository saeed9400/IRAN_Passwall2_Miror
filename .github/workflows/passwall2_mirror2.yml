name: IR_Passwall2m_Mirror

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  sync-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y jq unzip curl wget

      - name: Clean previous downloads
        run: rm -rf IR_Passwall2m/*

      - name: Get latest release info
        id: get-release
        run: |
          RELEASE_JSON=$(curl -s -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/Openwrt-Passwall/openwrt-passwall2/releases/latest)
          
          echo "$RELEASE_JSON" > release.json
          VERSION=$(echo "$RELEASE_JSON" | jq -r '.tag_name // .name // "unknown"')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          
          ASSET_COUNT=$(echo "$RELEASE_JSON" | jq '.assets | length')
          echo "Found $ASSET_COUNT assets"
          
          # ایجاد ساختار پوشه استاندارد OpenWrt
          echo "Creating standard OpenWrt directory structure..."

      - name: Create OpenWrt standard structure
        run: |
          # ساختار استاندارد مخزن OpenWrt
          BASE_DIR="IR_Passwall2m"
          mkdir -p "$BASE_DIR"
          
          # ایجاد پوشه برای هر معماری
          for arch in aarch64_cortex-a53 aarch64_cortex-a72 aarch64_generic \
                      arm_cortex-a7_neon-vfpv4 arm_cortex-a9 \
                      i386_pentium4 mips_24kc mipsel_24kc \
                      x86_64 x86_64_v2 x86_64_v3; do
            mkdir -p "$BASE_DIR/packages/$arch"
          done
          
          # پوشه برای کلید و indexها
          mkdir -p "$BASE_DIR/keys"

      - name: Download and organize packages
        run: |
          BASE_DIR="IR_Passwall2m"
          
          # دانلود و پردازش assets
          jq -r '
            .assets[]
            | select(.name | test("Source code|zipball|tarball"; "i") | not)
            | [.name, .browser_download_url] | @tsv
          ' release.json > assets_list.txt
          
          echo "Processing assets..."
          
          while IFS=$'\t' read -r NAME URL; do
            [ -z "$NAME" ] && continue
            
            echo "Processing: $NAME"
            
            # اگر فایل ipk است
            if [[ "$NAME" =~ \.ipk$ ]]; then
              # استخراج معماری از نام فایل
              ARCH=$(echo "$NAME" | grep -oP '(?<=_)[a-z0-9_]+(?=\.ipk)' || echo "unknown")
              
              if [ "$ARCH" != "unknown" ]; then
                DEST_DIR="$BASE_DIR/packages/$ARCH"
                mkdir -p "$DEST_DIR"
                
                echo "  → Downloading to $DEST_DIR/"
                curl -L --fail --silent --show-error -o "$DEST_DIR/$NAME" "$URL"
                
                # ساخت Packages.gz برای این معماری
                pushd "$DEST_DIR" > /dev/null
                /usr/lib/opkg/make-index . > Packages 2>/dev/null || true
                gzip -9fk Packages 2>/dev/null || true
                popd > /dev/null
              fi
            fi
            
            # اگر فایل zip پکیج‌ها است
            if [[ "$NAME" =~ passwall_packages.*\.zip$ ]]; then
              echo "  → Extracting ZIP package"
              TEMP_ZIP="temp_$$.zip"
              TEMP_DIR="temp_extract_$$"
              
              curl -L --fail --silent --show-error -o "$TEMP_ZIP" "$URL"
              unzip -o -q "$TEMP_ZIP" -d "$TEMP_DIR"
              
              # پیدا کردن تمام فایل‌های ipk و انتقال آنها
              find "$TEMP_DIR" -name "*.ipk" -type f | while read ipk_file; do
                IPK_NAME=$(basename "$ipk_file")
                
                # تشخیص معماری
                if [[ "$IPK_NAME" =~ luci-app-passwall2 ]]; then
                  # برای luci-app معماری همه
                  for arch_dir in "$BASE_DIR"/packages/*; do
                    if [ -d "$arch_dir" ]; then
                      cp "$ipk_file" "$arch_dir/"
                    fi
                  done
                else
                  # برای پکیج‌های معماری‌خاص
                  ARCH=$(echo "$IPK_NAME" | grep -oP '(?<=_)[a-z0-9_]+(?=\.ipk$)' || echo "all")
                  if [[ "$ARCH" == "all" || -z "$ARCH" ]]; then
                    ARCH="all"
                    DEST_DIR="$BASE_DIR/packages/all"
                    mkdir -p "$DEST_DIR"
                    cp "$ipk_file" "$DEST_DIR/"
                  else
                    DEST_DIR="$BASE_DIR/packages/$ARCH"
                    mkdir -p "$DEST_DIR"
                    cp "$ipk_file" "$DEST_DIR/"
                  fi
                fi
              done
              
              rm -rf "$TEMP_ZIP" "$TEMP_DIR"
            fi
            
          done < assets_list.txt

      - name: Generate repository metadata
        run: |
          BASE_DIR="IR_Passwall2m"
          
          # ایجاد فایل index برای هر معماری
          for arch_dir in "$BASE_DIR"/packages/*; do
            if [ -d "$arch_dir" ] && [ -n "$(ls "$arch_dir"/*.ipk 2>/dev/null)" ]; then
              echo "Generating Packages for $(basename "$arch_dir")"
              pushd "$arch_dir" > /dev/null
              
              # حذف فایل‌های قدیمی
              rm -f Packages Packages.gz
              
              # ایجاد index جدید
              /usr/lib/opkg/make-index . > Packages 2>/dev/null || \
                dpkg-scanpackages . /dev/null 2>/dev/null | gzip -9c > Packages.gz
              
              # اگر opkg-index در دسترس نیست
              if [ ! -f Packages.gz ] && [ -f Packages ]; then
                gzip -9fk Packages
              fi
              
              popd > /dev/null
            fi
          done
          
          # ایجاد فایل version
          echo "${{ env.VERSION }}" > "$BASE_DIR/version.txt"
          date > "$BASE_DIR/last_update.txt"

      - name: Commit and push changes
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          git add IR_Passwall2m/
          
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update: Passwall2 packages ${{ env.VERSION }}"
            git push
          fi

      - name: Cleanup
        run: |
          rm -f release.json assets_list.txt