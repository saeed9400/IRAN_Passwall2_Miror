name: Sync OpenWrt Passwall2 Repository

on:
  schedule:
    # Ø±ÙˆØ²ÛŒ ÛŒÚ©Ø¨Ø§Ø± Ø§Ø¬Ø±Ø§ Ø´ÙˆØ¯ (Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒØ¯)
    - cron: '0 0 * * *'
  workflow_dispatch:  # Ø§Ù…Ú©Ø§Ù† Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÛŒ
  repository_dispatch: # Ø§Ù…Ú©Ø§Ù† Ø§Ø¬Ø±Ø§ Ø§Ø² Ø·Ø±ÛŒÙ‚ webhook

permissions:
  contents: write

jobs:
  sync-passwall2:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup environment
      run: |
        sudo apt-get update
        sudo apt-get install -y curl jq wget unzip

    - name: Get latest release info
      id: get_release
      run: |
        # Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¢Ø®Ø±ÛŒÙ† Ù†Ø³Ø®Ù‡ Ø§Ø² GitHub API
        API_URL="https://api.github.com/repos/Openwrt-Passwall/openwrt-passwall2/releases/latest"
        
        RESPONSE=$(curl -s "$API_URL")
        TAG_NAME=$(echo "$RESPONSE" | jq -r '.tag_name')
        RELEASE_NAME=$(echo "$RESPONSE" | jq -r '.name')
        
        # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù†Ø³Ø®Ù‡ Ø§Ø² tag ÛŒØ§ name
        VERSION="$TAG_NAME"
        if [[ "$TAG_NAME" == "" || "$TAG_NAME" == "null" ]]; then
          VERSION="$RELEASE_NAME"
        fi
        
        echo "Latest version: $VERSION"
        echo "TAG_NAME: $TAG_NAME"
        echo "RELEASE_NAME: $RELEASE_NAME"
        
        # Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯Ø± outputs
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        
        # Ø§ÛŒØ¬Ø§Ø¯ Ù„ÛŒØ³Øª asset Ù‡Ø§
        echo "$RESPONSE" | jq -r '.assets[] | "\(.name)|\(.browser_download_url)"' > assets.txt
        echo "Assets list created"

    - name: Create version directory
      run: |
        # Ø­Ø°Ù Ú©Ø§Ø±Ø§Ú©ØªØ±Ù‡Ø§ÛŒ ØºÛŒØ±Ù…Ø¬Ø§Ø² Ø§Ø² Ù†Ø§Ù… Ù¾ÙˆØ´Ù‡
        CLEAN_VERSION=$(echo "$VERSION" | tr -d '[:space:]' | sed 's/[\/:*?"<>|]//g')
        echo "Clean version: $CLEAN_VERSION"
        
        # Ø§ÛŒØ¬Ø§Ø¯ Ù¾ÙˆØ´Ù‡ Ø§ØµÙ„ÛŒ
        mkdir -p "IR_Passwall2_M/$CLEAN_VERSION"
        echo "Created directory: IR_Passwall2_M/$CLEAN_VERSION"

    - name: Download and process files
      run: |
        CLEAN_VERSION=$(echo "$VERSION" | tr -d '[:space:]' | sed 's/[\/:*?"<>|]//g')
        
        # Ø®ÙˆØ§Ù†Ø¯Ù† ÙØ§ÛŒÙ„ assets
        while IFS='|' read -r FILENAME URL; do
          echo "Processing: $FILENAME"
          
          # Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ú¯Ø±ÙØªÙ† source code files
          if [[ "$FILENAME" == *"Source code"* ]]; then
            echo "Skipping source code file: $FILENAME"
            continue
          fi
          
          # Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„
          echo "Downloading: $FILENAME"
          wget -q -O "$FILENAME" "$URL"
          
          if [[ $? -eq 0 ]]; then
            echo "Downloaded successfully: $FILENAME"
            
            # Ù¾Ø±Ø¯Ø§Ø²Ø´ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ ipk Ùˆ apk
            if [[ "$FILENAME" == *.ipk || "$FILENAME" == *.apk ]]; then
              echo "Copying IPK/APK file directly"
              cp "$FILENAME" "IR_Passwall2_M/$CLEAN_VERSION/"
            fi
            
            # Ù¾Ø±Ø¯Ø§Ø²Ø´ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ zip
            if [[ "$FILENAME" == *.zip ]]; then
              echo "Extracting ZIP file: $FILENAME"
              
              # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù†Ø§Ù… Ù…Ø¹Ù…Ø§Ø±ÛŒ Ø§Ø² Ø§Ø³Ù… ÙØ§ÛŒÙ„
              # ÙØ±Ù…Øª: passwall_packages_apk_aarch64_cortex-a53.zip
              if [[ "$FILENAME" =~ passwall_packages_apk_(.+)\.zip$ ]]; then
                ARCH_PATH="${BASH_REMATCH[1]}"
                echo "Detected architecture path: $ARCH_PATH"
                
                # Ø§Ø³ØªØ®Ø±Ø§Ø¬ architecture Ùˆ subarchitecture
                if [[ "$ARCH_PATH" =~ ^([^_]+)_(.+)$ ]]; then
                  ARCH="${BASH_REMATCH[1]}"
                  SUBARCH="${BASH_REMATCH[2]}"
                  
                  echo "Architecture: $ARCH"
                  echo "Subarchitecture: $SUBARCH"
                  
                  # Ø§ÛŒØ¬Ø§Ø¯ Ù¾ÙˆØ´Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ù‚ØµØ¯
                  DEST_DIR="IR_Passwall2_M/$CLEAN_VERSION/$ARCH/$SUBARCH"
                  mkdir -p "$DEST_DIR"
                  
                  # Ø§Ú©Ø³ØªØ±Ú©Øª Ú©Ø±Ø¯Ù† ÙØ§ÛŒÙ„ zip
                  unzip -q -d "$DEST_DIR" "$FILENAME"
                  
                  echo "Extracted to: $DEST_DIR"
                elif [[ "$ARCH_PATH" =~ ^([^_]+)$ ]]; then
                  # Ø­Ø§Ù„Øª Ø¨Ø¯ÙˆÙ† subarchitecture
                  ARCH="${BASH_REMATCH[1]}"
                  echo "Single level architecture: $ARCH"
                  
                  DEST_DIR="IR_Passwall2_M/$CLEAN_VERSION/$ARCH"
                  mkdir -p "$DEST_DIR"
                  
                  unzip -q -d "$DEST_DIR" "$FILENAME"
                  
                  echo "Extracted to: $DEST_DIR"
                fi
              fi
            fi
            
            # Ø­Ø°Ù ÙØ§ÛŒÙ„ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯Ù‡
            rm "$FILENAME"
          else
            echo "Failed to download: $FILENAME"
          fi
          
          echo "---"
          
        done < assets.txt

    - name: Commit and push changes
      run: |
        # ØªÙ†Ø¸ÛŒÙ… Ø§Ø·Ù„Ø§Ø¹Ø§Øª Git
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # Ø¨Ø±Ø±Ø³ÛŒ ØªØºÛŒÛŒØ±Ø§Øª
        if git diff --quiet && git diff --staged --quiet; then
          echo "No changes to commit"
        else
          # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ØªØºÛŒÛŒØ±Ø§Øª
          git add IR_Passwall2_M/
          
          # Ú©Ø§Ù…ÛŒØª ØªØºÛŒÛŒØ±Ø§Øª
          git commit -m "ğŸ”— Sync Passwall2 version $VERSION [$(date +'%Y-%m-%d %H:%M:%S')]"
          
          # Push Ø¨Ù‡ Ø±ÛŒÙ¾Ø§Ø²ÛŒØªÙˆØ±ÛŒ
          git push
          echo "Changes pushed successfully"
        fi