name: IR_Passwall2G_Mirror

on:
  schedule:
    - cron: '0 3 * * *'       # کمی تصادفی‌تر از 00:00
  workflow_dispatch:

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y jq unzip curl coreutils

      - name: Get latest release
        id: release
        run: |
          curl -s -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/Openwrt-Passwall/openwrt-passwall2/releases/latest > rel.json

          VER=$(jq -r '.tag_name // "unknown"' rel.json)
          echo "VER=$VER" >> $GITHUB_ENV

          # برای استخراج نسخه اصلی مثلاً 26.1 از 26.1.31-r1
          BASE_VER=$(echo "$VER" | grep -oE '^[0-9]+\.[0-9]+' || echo "26")

      - name: Prepare directories
        run: |
          mkdir -p IR_Passwall2/openwrt-${{ env.BASE_VER }}

      - name: Download & organize
        run: |
          TARGET="IR_Passwall2/openwrt-${{ env.BASE_VER }}"

          jq -r '.assets[] | select(.name | test("Source code|zipball|tarball"; "i") | not) | [.name, .browser_download_url] | @tsv' rel.json > assets.tsv

          while IFS=$'\t' read -r name url; do
            [[ -z "$name" ]] && continue

            echo "→ $name"

            if [[ "$name" == *.ipk || "$name" == *.apk ]]; then
              curl -L --fail -o "$TARGET/$name" "$url" && echo "   OK" || echo "   failed"
            fi

            if [[ "$name" =~ passwall_packages_apk_([a-z0-9]+)_([a-z0-9._-]+)\.zip ]]; then
              arch="${BASH_REMATCH[1]}"
              sub="${BASH_REMATCH[2]}"

              curl -L --fail -o tmp.zip "$url" || continue

              unzip -q -o tmp.zip -d tmp_ex || { rm tmp.zip; continue; }

              dest="$TARGET/$arch"
              [[ -n "$sub" && "$sub" != "generic" ]] && dest="$dest/$sub"

              mkdir -p "$dest"
              mv tmp_ex/*.ipk tmp_ex/*.apk "$dest/" 2>/dev/null || true

              rm -rf tmp_ex tmp.zip
              echo "   → extracted to $dest"
            fi
          done < assets.tsv

      - name: Create latest symlink (اختیاری)
        run: |
          cd IR_Passwall2
          ln -sf openwrt-${{ env.BASE_VER }} latest || true

      - name: Commit changes
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add IR_Passwall2/
          if git diff --staged --quiet; then
            echo "No change"
          else
            git commit -m "Mirror update: ${{ env.VER }}"
            git push || echo "Push failed (maybe protected branch)"
          fi