name: passwall2 gr3

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  sync-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y jq unzip curl

      - name: Get latest release info
        id: get-release
        run: |
          curl -s -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/Openwrt-Passwall/openwrt-passwall2/releases/latest > release.json
          
          VERSION=$(jq -r '.tag_name // "unknown"' release.json)
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          
          ASSET_COUNT=$(jq '.assets | length' release.json)
          echo "Found $ASSET_COUNT assets in release.json"

      - name: Create version folder
        run: mkdir -p "IR_Passwall2/${{ env.VERSION }}"

      - name: Download and organize assets
        run: |
          TARGET_DIR="IR_Passwall2/${{ env.VERSION }}"
          echo "Target directory: $TARGET_DIR"
          
          # استخراج لیست name\turl به فایل (روش پایدار)
          jq -r '
            .assets[]
            | select(.name | test("Source code|zipball|tarball"; "i") | not)
            | [.name, .browser_download_url] | @tsv
          ' release.json > assets_list.txt
          
          echo "Assets list line count:"
          wc -l < assets_list.txt || echo "File not created or empty"
          
          # برای debug کامل: ۵ خط اول و آخر را چاپ کن
          echo "First few lines of assets_list.txt:"
          head -n 5 assets_list.txt || echo "(empty)"
          echo "..."
          echo "Last few lines:"
          tail -n 5 assets_list.txt || echo "(empty)"
          
          # پردازش
          while IFS=$'\t' read -r NAME URL; do
            [ -z "$NAME" ] && continue
            
            echo "→ Processing: $NAME"
            
            if [[ "$NAME" == *.apk || "$NAME" == *.ipk ]]; then
              echo "  → Downloading $NAME"
              curl -L --fail --silent --show-error -o "$TARGET_DIR/$NAME" "$URL" \
                && echo "    OK" || echo "    Download failed"
            fi
            
            if [[ "$NAME" == passwall_packages_apk_*.zip ]]; then
              echo "  → Downloading ZIP $NAME"
              curl -L --fail --silent --show-error -o temp.zip "$URL" || { echo "    Download failed"; continue; }
              
              echo "  → Extracting..."
              unzip -o -q temp.zip -d temp_extract || { echo "    Unzip failed"; rm -f temp.zip; continue; }
              
              if [[ $NAME =~ passwall_packages_apk_([a-z0-9]+)_([a-z0-9._-]+)\.zip ]]; then
                ARCH="${BASH_REMATCH[1]}"
                SUBARCH="${BASH_REMATCH[2]}"
                DEST="$TARGET_DIR/$ARCH/$SUBARCH"
              else
                DEST="$TARGET_DIR/unknown"
                echo "  → Arch parse failed → $DEST"
              fi
              
              mkdir -p "$DEST"
              mv temp_extract/* "$DEST/" 2>/dev/null && echo "    Moved OK" || echo "    Move issue"
              
              rm -rf temp_extract temp.zip
              echo "  → Extracted to $DEST"
            fi
          done < assets_list.txt

      - name: Show final structure (debug)
        run: |
          echo "Final structure:"
          if [ -d "IR_Passwall2" ]; then
            find IR_Passwall2 -print | sort
            echo "Sizes:"
            du -sh IR_Passwall2/* 2>/dev/null || true
          else
            echo "No IR_Passwall2 folder created"
          fi

      - name: Commit and push if changes
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          git add IR_Passwall2/
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Auto mirror latest release: ${{ env.VERSION }}"
            git push || echo "Push failed"
          fi