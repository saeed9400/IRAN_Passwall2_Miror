name: IR_Passwall2_Index

on:
  push:
    branches: [ main ]
    paths:
      - 'irpasswall2_repo/**'
  workflow_dispatch:
  schedule:
    - cron: '10 0 * * *'

jobs:
  build-index:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install tools
        run: |
          sudo apt-get update && sudo apt-get install -y coreutils libarchive-tools gzip

      - name: Generate Packages index
        run: |
          BASE_DIR="irpasswall2_repo"
          PACKAGES_FILE="$(pwd)/${BASE_DIR}/Packages"
          PACKAGES_GZ="$(pwd)/${BASE_DIR}/Packages.gz"

          echo "Building Packages index..."

          # پیدا کردن آخرین نسخه (26.2.5-1 یا v...)
          LATEST_VERSION=$(ls -1vd "${BASE_DIR}"/* 2>/dev/null | \
                           grep -E '([0-9]+\.[0-9]+\.[0-9]+(-[0-9]+)?)$' | \
                           sort -V | tail -n 1)

          if [ -z "$LATEST_VERSION" ]; then
            echo "❌ No version folders found!"
            ls -la "${BASE_DIR}" || echo "Directory empty"
            exit 1
          fi

          PKG_DIR="${BASE_DIR}/${LATEST_VERSION}/packages"
          echo "✅ Using: $(basename "$LATEST_VERSION")"
          echo "Scanning: $PKG_DIR"

          if [ ! -d "$PKG_DIR" ]; then
            echo "❌ No packages dir: $PKG_DIR"
            exit 1
          fi

          cd "$PKG_DIR" || exit 1

          rm -f "$PACKAGES_FILE" "$PACKAGES_GZ" 2>/dev/null
          > "$PACKAGES_FILE"

          find . -name '*.ipk' -type f -print0 | sort -z | while IFS= read -r -d '' pkg; do
            filename="${pkg#./}"
            size=$(stat -c %s "$pkg" 2>/dev/null || echo 0)
            md5=$(md5sum "$pkg" 2>/dev/null | cut -d' ' -f1 || echo "00000000000000000000000000000000")
            sha256=$(sha256sum "$pkg" 2>/dev/null | cut -d' ' -f1 || echo "0000000000000000000000000000000000000000000000000000000000000000")

            control=$(tar -xOf "$pkg" ./control.tar.gz 2>/dev/null | zcat | tar -xOf - ./control 2>/dev/null)
            if [ -z "$control" ]; then
              control=$(tar --wildcards -xOf "$pkg" '*control*' 2>/dev/null)
            fi

            if [ -n "$control" ]; then
              printf '%s\n' "$control"
              printf 'Filename: %s\n' "$filename"
              printf 'Size: %s\n' "$size"
              printf 'MD5Sum: %s\n' "$md5"
              printf 'SHA256sum: %s\n' "$sha256"
              printf '\n'
            fi
          done >> "$PACKAGES_FILE"

          if [ -s "$PACKAGES_FILE" ]; then
            gzip -9 -c "$PACKAGES_FILE" > "$PACKAGES_GZ"
            echo "✅ Created:"
            echo " - Packages: $(wc -l < "$PACKAGES_FILE") lines"
            echo " - Packages.gz: $(du -h "$PACKAGES_GZ" | cut -f1)"
          else
            echo "❌ No valid ipk or control failed"
          fi

      - name: Commit index files if changed
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          git add irpasswall2_repo/Packages irpasswall2_repo/Packages.gz || true
          
          if git diff --staged --quiet; then
            echo "No changes in index"
          else
            git commit -m "Update opkg index files (auto)"
            git push
          fi

      - name: Debug - final check
        run: |
          echo "Index files:"
          ls -lh irpasswall2_repo/Packages* 2>/dev/null || echo "Not found"
          head -n 20 irpasswall2_repo/Packages || echo "(empty)"
