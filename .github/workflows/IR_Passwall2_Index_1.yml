name: IR_Passwall2_Index

on:
  push:
    branches: [ main ]
    paths:
      - 'irpasswall2_repo/**'
  workflow_dispatch:
  schedule:
    - cron: '10 0 * * *'

jobs:
  build-index:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install tools
        run: |
          sudo apt-get update && sudo apt-get install -y coreutils libarchive-tools gzip

      - name: Generate Packages index
        run: |
          BASE_DIR="irpasswall2_repo"
          PACKAGES_FILE="$(pwd)/${BASE_DIR}/Packages"
          PACKAGES_GZ="$(pwd)/${BASE_DIR}/Packages.gz"

          echo "Building opkg index..."

          # فقط نام پوشه‌های نسخه را استخراج می‌کنیم
          VERSION_FOLDERS=$(ls -1 "${BASE_DIR}" 2>/dev/null | grep -E '^[0-9]+\.[0-9]+\.[0-9]+(-[0-9]+)?$')

          if [ -z "$VERSION_FOLDERS" ]; then
            echo "❌ No version folders found in ${BASE_DIR}"
            ls -la "${BASE_DIR}" || echo "Directory empty"
            exit 1
          fi

          # آخرین نسخه (جدیدترین با sort -V)
          LATEST_VERSION=$(echo "$VERSION_FOLDERS" | sort -V | tail -n 1)

          PKG_DIR="${BASE_DIR}/${LATEST_VERSION}/packages"
          echo "✅ Latest version folder: $LATEST_VERSION"
          echo "Scanning: $PKG_DIR"

          if [ ! -d "$PKG_DIR" ]; then
            echo "❌ Packages dir not found: $PKG_DIR"
            exit 1
          fi

          cd "$PKG_DIR" || exit 1

          rm -f "$PACKAGES_FILE" "$PACKAGES_GZ" 2>/dev/null
          > "$PACKAGES_FILE"

          find . -name '*.ipk' -type f -print0 | sort -z | while IFS= read -r -d '' pkg; do
            filename="${pkg#./}"
            size=$(stat -c %s "$pkg" 2>/dev/null || echo 0)
            md5=$(md5sum "$pkg" 2>/dev/null | cut -d' ' -f1 || echo "00000000000000000000000000000000")
            sha256=$(sha256sum "$pkg" 2>/dev/null | cut -d' ' -f1 || echo "0000000000000000000000000000000000000000000000000000000000000000")

            control=$(tar -xOf "$pkg" ./control.tar.gz 2>/dev/null | zcat | tar -xOf - ./control 2>/dev/null)
            if [ -z "$control" ]; then
              control=$(tar --wildcards -xOf "$pkg" '*control*' 2>/dev/null)
            fi

            if [ -n "$control" ]; then
              printf '%s\n' "$control"
              printf 'Filename: %s\n' "$filename"
              printf 'Size: %s\n' "$size"
              printf 'MD5Sum: %s\n' "$md5"
              printf 'SHA256sum: %s\n' "$sha256"
              printf '\n'
            fi
          done >> "$PACKAGES_FILE"

          if [ -s "$PACKAGES_FILE" ]; then
            gzip -9 -c "$PACKAGES_FILE" > "$PACKAGES_GZ"
            echo "✅ Success:"
            echo " - Packages lines: $(wc -l < "$PACKAGES_FILE")"
            echo " - Packages.gz size: $(du -h "$PACKAGES_GZ" | cut -f1)"
          else
            echo "❌ No .ipk or control failed"
            find . -name '*.ipk' || echo "No .ipk at all"
          fi

      - name: Commit index files if changed
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          git add irpasswall2_repo/Packages irpasswall2_repo/Packages.gz || true
          
          if git diff --staged --quiet; then
            echo "No changes in index files"
          else
            git commit -m "Update opkg Packages index (auto)"
            git push
          fi

      - name: Final debug
        run: |
          echo "Index files check:"
          ls -lh irpasswall2_repo/Packages* 2>/dev/null || echo "Not found"
          head -n 20 irpasswall2_repo/Packages 2>/dev/null || echo "(empty)"
