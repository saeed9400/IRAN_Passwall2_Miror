name: IR_Passwall2_Index_2

on:
  push:
    branches: [ main ]
    paths:
      - 'irpasswall2_repo/**'
  workflow_dispatch:
  schedule:
    - cron: '10 0 * * *'

jobs:
  build-index:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install tools
        run: |
          sudo apt-get update && sudo apt-get install -y coreutils libarchive-tools gzip

      - name: Generate Packages index
        run: |
          BASE_DIR="irpasswall2_repo"
          PACKAGES_FILE="${BASE_DIR}/Packages"
          PACKAGES_GZ="${BASE_DIR}/Packages.gz"

          echo "Building Packages index from irpasswall2_repo..."

          # پیدا کردن آخرین پوشه نسخه (الگوی عددی مثل 26.2.5-1 یا v26.2.5-1)
          LATEST_VERSION=$(ls -1vd "${BASE_DIR}"/* 2>/dev/null | \
                           grep -E '([0-9]+\.[0-9]+\.[0-9]+(-[0-9]+)?)$' | \
                           sort -V | tail -n 1)

          if [ -z "$LATEST_VERSION" ]; then
            echo "❌ No version folders found in $BASE_DIR!"
            ls -la "${BASE_DIR}" || echo "Directory is empty"
            exit 1
          fi

          PKG_DIR="${LATEST_VERSION}/packages"
          echo "✅ Using latest version folder: $(basename "$LATEST_VERSION")"
          echo "Scanning packages in: $PKG_DIR"

          if [ ! -d "$PKG_DIR" ]; then
            echo "❌ Packages directory not found: $PKG_DIR"
            exit 1
          fi

          cd "$PKG_DIR" || exit 1

          rm -f "../../Packages" "../../Packages.gz" 2>/dev/null
          > "../../Packages"

          # ایندکس کردن همه .ipk از همه معماری‌ها
          find . -name '*.ipk' -type f -print0 | sort -z | while IFS= read -r -d '' pkg; do
            filename="${pkg#./}"
            size=$(stat -c %s "$pkg" 2>/dev/null || echo 0)
            md5=$(md5sum "$pkg" 2>/dev/null | cut -d' ' -f1 || echo "00000000000000000000000000000000")
            sha256=$(sha256sum "$pkg" 2>/dev/null | cut -d' ' -f1 || echo "0000000000000000000000000000000000000000000000000000000000000000")

            control=$(tar -xOf "$pkg" ./control.tar.gz 2>/dev/null | zcat | tar -xOf - ./control 2>/dev/null)
            if [ -z "$control" ]; then
              control=$(tar --wildcards -xOf "$pkg" '*control*' 2>/dev/null)
            fi

            if [ -n "$control" ]; then
              printf '%s\n' "$control"
              printf 'Filename: %s\n' "$filename"
              printf 'Size: %s\n' "$size"
              printf 'MD5Sum: %s\n' "$md5"
              printf 'SHA256sum: %s\n' "$sha256"
              printf '\n'
            else
              echo "Warning: No control found in $filename" >&2
            fi
          done >> "../../Packages"

          if [ -s "../../Packages" ]; then
            gzip -9 -c "../../Packages" > "../../Packages.gz"
            echo "✅ Successfully created:"
            echo " - Packages: $(wc -l < "../../Packages") lines"
            echo " - Packages.gz: $(du -h "../../Packages.gz" | cut -f1)"
          else
            echo "❌ No valid .ipk files found or control extraction failed"
            find . -name '*.ipk' -type f || echo "No .ipk files at all"
          fi

      - name: Commit index files if changed
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          git add "${BASE_DIR}/Packages" "${BASE_DIR}/Packages.gz" || true
          
          if git diff --staged --quiet; then
            echo "No changes in index files"
          else
            git commit -m "Update opkg index files (auto)"
            git push
          fi

      - name: Debug - show index files
        run: |
          echo "Index files status:"
          ls -lh "${BASE_DIR}/Packages"* 2>/dev/null || echo "No Packages files created"
          head -n 20 "${BASE_DIR}/Packages" || echo "(empty)"
