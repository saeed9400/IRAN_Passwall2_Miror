name: IR_Passwall2_Index

on:
  push:
    branches: [ main ]
    paths:
      - 'irpasswall2_repo/**'
  workflow_dispatch:
  schedule:
    - cron: '10 0 * * *'

jobs:
  build-index:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install tools
        run: |
          sudo apt-get update && sudo apt-get install -y coreutils libarchive-tools gzip

      - name: Generate Packages index
        run: |
          BASE_DIR="irpasswall2_repo"
          PACKAGES_FILE="${BASE_DIR}/Packages"
          PACKAGES_GZ="${BASE_DIR}/Packages.gz"

          echo "Building Packages index..."

          # پیدا کردن آخرین نسخه (با یا بدون v)
          LATEST_VERSION=$(ls -1vd ${BASE_DIR}/* 2>/dev/null | grep -E '^[0-9]+\.[0-9]+\.[0-9]+(-[0-9]+)?$' | sort -V | tail -n 1)

          if [ -z "$LATEST_VERSION" ]; then
            echo "No version folders found in $BASE_DIR!"
            exit 1
          fi

          PKG_DIR="${BASE_DIR}/${LATEST_VERSION}/packages"
          echo "Using latest version: $LATEST_VERSION"
          echo "Scanning: $PKG_DIR"

          if [ ! -d "$PKG_DIR" ]; then
            echo "Package directory not found: $PKG_DIR"
            exit 1
          fi

          cd "$PKG_DIR" || exit 1

          rm -f "../../Packages" "../../Packages.gz" 2>/dev/null
          > "../../Packages"

          # ایندکس کردن همه ipkها از همه معماری‌ها
          find . -name '*.ipk' -type f -print0 | sort -z | while IFS= read -r -d '' pkg; do
            filename="${pkg#./}"
            size=$(stat -c %s "$pkg" 2>/dev/null || echo 0)
            md5=$(md5sum "$pkg" 2>/dev/null | cut -d' ' -f1 || echo "00000000000000000000000000000000")
            sha256=$(sha256sum "$pkg" 2>/dev/null | cut -d' ' -f1 || echo "0000000000000000000000000000000000000000000000000000000000000000")

            control=$(tar -xOf "$pkg" ./control.tar.gz 2>/dev/null | zcat | tar -xOf - ./control 2>/dev/null)
            if [ -z "$control" ]; then
              control=$(tar --wildcards -xOf "$pkg" '*control*' 2>/dev/null)
            fi

            if [ -n "$control" ]; then
              printf '%s\n' "$control"
              printf 'Filename: %s\n' "$filename"
              printf 'Size: %s\n' "$size"
              printf 'MD5Sum: %s\n' "$md5"
              printf 'SHA256sum: %s\n' "$sha256"
              printf '\n'
            else
              echo "Warning: No control found in $filename" >&2
            fi
          done >> "../../Packages"

          if [ -s "../../Packages" ]; then
            gzip -9 -c "../../Packages" > "../../Packages.gz"
            echo "✅ Packages and Packages.gz created!"
            echo "Lines in Packages: $(wc -l < "../../Packages")"
            du -h "../../Packages" "../../Packages.gz"
          else
            echo "❌ No valid ipk files or control extraction failed"
          fi

      - name: Commit index files if changed
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          git add irpasswall2_repo/Packages irpasswall2_repo/Packages.gz || true
          
          if git diff --staged --quiet; then
            echo "No changes in index files"
          else
            git commit -m "Update Packages index (auto)"
            git push
          fi

      - name: Debug final files
        run: |
          ls -lh irpasswall2_repo/Packages* || echo "No Packages files"
          head -n 20 irpasswall2_repo/Packages || echo "(empty)"
