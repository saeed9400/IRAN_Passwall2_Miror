name: Mirror Passwall2

on:
  schedule:
    - cron: '0 5 * * *'
  workflow_dispatch:

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install deps
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y jq unzip curl coreutils libarchive-tools gzip

      - name: Get latest release
        run: |
          curl -sSf -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/Openwrt-Passwall/openwrt-passwall2/releases/latest > rel.json
          
          VERSION=$(jq -r .tag_name rel.json)
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "VER_FOLDER=v$VERSION" >> $GITHUB_ENV
          echo "BASE_DIR=irpasswall2_repo" >> $GITHUB_ENV

      - name: Clean old versions (keep last 2)
        run: |
          mkdir -p "${{ env.BASE_DIR }}"
          cd "${{ env.BASE_DIR }}"
          ls -d v* 2>/dev/null | grep -E '^v[0-9]+\.[0-9]+' | sort -V | head -n -2 | xargs rm -rfv || true
          cd -

      - name: Extract asset list
        run: |
          jq -r '
            .assets[]
            | select(.name | test("Source code"; "i") | not)
            | [.name, .browser_download_url] | @tsv
          ' rel.json > assets_list.tsv
          
          echo "Assets count: $(wc -l < assets_list.tsv)"
          head -n 8 assets_list.tsv

      - name: Download & organize
        run: |
          BASE="${{ env.BASE_DIR }}"
          TARGET="${BASE}/${{ env.VER_FOLDER }}/packages"
          mkdir -p "$TARGET"
          
          while IFS=$'\t' read -r NAME URL; do
            [ -z "$NAME" ] && continue
            
            echo "→ $NAME"
            
            if [[ "$NAME" == *.ipk || "$NAME" == *.apk ]]; then
              arch="all"
              if [[ "$NAME" =~ _([a-z0-9_-]+)\.(ipk|apk)$ ]]; then
                arch="${BASH_REMATCH[1]}"
              fi
              mkdir -p "$TARGET/$arch"
              curl -L --fail -sS -o "$TARGET/$arch/$NAME" "$URL" || echo "Failed: $NAME"
            fi
            
            if [[ "$NAME" =~ passwall_packages_(apk|ipk)_(.+)\.zip ]]; then
              pkg_type="${BASH_REMATCH[1]}"
              arch_full="${BASH_REMATCH[2]}"
              mkdir -p "$TARGET/$arch_full"
              
              curl -L --fail -sS -o temp.zip "$URL" || continue
              unzip -q -o temp.zip -d temp_extract || { rm -f temp.zip; continue; }
              
              # انتقال همه فایل‌های ipk/apk به پوشه معماری
              find temp_extract -type f \( -name '*.ipk' -o -name '*.apk' \) -exec mv {} "$TARGET/$arch_full/" \;
              
              rm -rf temp.zip temp_extract
              echo "Extracted $NAME → $arch_full"
            fi
          done < assets_list.tsv

          # کپی all به همه معماری‌ها
          cd "$TARGET" || exit 1
          if [ -d all ] && ls all/*.{ipk,apk} >/dev/null 2>&1; then
            for d in */ ; do
              [[ $d == all/ ]] && continue
              cp -f all/* "$d" 2>/dev/null
            done
          fi

      - name: Generate Packages index
        run: |
          cd "${{ env.BASE_DIR }}/${{ env.VER_FOLDER }}/packages" || exit 1
          
          > "${{ env.BASE_DIR }}/Packages"
          
          find . -name '*.ipk' -print0 | sort -z | while IFS= read -r -d '' f; do
            fn="${f#./}"
            sz=$(stat -c %s "$f")
            md5=$(md5sum "$f" | cut -d' ' -f1)
            sha256=$(sha256sum "$f" | cut -d' ' -f1)
            
            ctrl=$(tar -xOf "$f" ./control.tar.gz 2>/dev/null | zcat | tar -xOf - ./control 2>/dev/null)
            [ -z "$ctrl" ] && ctrl=$(tar --wildcards -xOf "$f" '*control*' 2>/dev/null)
            
            echo "$ctrl"
            echo "Filename: $fn"
            echo "Size: $sz"
            echo "MD5Sum: $md5"
            echo "SHA256sum: $sha256"
            echo ""
          done >> "${{ env.BASE_DIR }}/Packages"
          
          gzip -9 -c "${{ env.BASE_DIR }}/Packages" > "${{ env.BASE_DIR }}/Packages.gz"

      - name: Debug structure
        run: |
          find "${{ env.BASE_DIR }}" -type f | sort
          du -sh "${{ env.BASE_DIR }}"/* || true

      - name: Commit
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add "${{ env.BASE_DIR }}" Packages* assets_list.tsv || true
          if ! git diff --staged --quiet; then
            git commit -m "Mirror ${{ env.VERSION }} - base folder"
            git push
          fi