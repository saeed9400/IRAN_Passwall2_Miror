name: Mirror Passwall2

on:
  schedule:
    - cron: '0 5 * * *'
  workflow_dispatch:

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install deps
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y jq unzip curl coreutils libarchive-tools gzip

      - name: Get latest release
        run: |
          curl -sSf -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/Openwrt-Passwall/openwrt-passwall2/releases/latest > rel.json
          
          VERSION=$(jq -r .tag_name rel.json)
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "VER_FOLDER=v$VERSION" >> $GITHUB_ENV
          echo "BASE_DIR=irpasswall2_repo" >> $GITHUB_ENV

      - name: Clean old versions (keep last 2)
        run: |
          mkdir -p "${{ env.BASE_DIR }}"
          cd "${{ env.BASE_DIR }}"
          ls -d v* 2>/dev/null | grep -E '^v[0-9]+\.[0-9]+' | sort -V | head -n -2 | xargs rm -rfv || true
          cd -

      - name: Extract asset list
        run: |
          jq -r '
            .assets[]
            | select(.name | test("Source code"; "i") | not)
            | [.name, .browser_download_url] | @tsv
          ' rel.json > assets_list.tsv
          
          echo "Assets count: $(wc -l < assets_list.tsv || echo '0')"
          head -n 8 assets_list.tsv || true

      - name: Download & organize
        run: |
          BASE="${{ env.BASE_DIR }}"
          TARGET="${BASE}/${{ env.VER_FOLDER }}/packages"
          mkdir -p "$TARGET"
          
          while IFS=$'\t' read -r NAME URL; do
            [ -z "$NAME" ] && continue
            
            echo "→ $NAME"
            
            if [[ "$NAME" == *.ipk || "$NAME" == *.apk ]]; then
              arch="all"
              if [[ "$NAME" =~ _([a-z0-9_-]+)\.(ipk|apk)$ ]]; then
                arch="${BASH_REMATCH[1]}"
              fi
              mkdir -p "$TARGET/$arch"
              curl -L --fail -sS -o "$TARGET/$arch/$NAME" "$URL" || echo "Failed: $NAME"
            fi
            
            if [[ "$NAME" =~ passwall_packages_(apk|ipk)_(.+)\.zip ]]; then
              pkg_type="${BASH_REMATCH[1]}"
              arch_full="${BASH_REMATCH[2]}"
              mkdir -p "$TARGET/$arch_full"
              
              curl -L --fail -sS -o temp.zip "$URL" || continue
              unzip -q -o temp.zip -d temp_extract || { rm -f temp.zip; continue; }
              
              find temp_extract -type f \( -name '*.ipk' -o -name '*.apk' \) -exec mv {} "$TARGET/$arch_full/" \;
              
              rm -rf temp.zip temp_extract
              echo "Extracted $NAME → $arch_full"
            fi
          done < assets_list.tsv

          cd "$TARGET" || exit 1
          if [ -d all ] && ls all/*.{ipk,apk} >/dev/null 2>&1; then
            for d in */ ; do
              [[ $d == all/ ]] && continue
              cp -f all/* "$d" 2>/dev/null
            done
          fi

      - name: Generate Packages index
        run: |
          BASE_DIR="irpasswall2_repo"
          VER_FOLDER="v${{ env.VERSION }}"
          PKG_DIR="${BASE_DIR}/${VER_FOLDER}/packages"
          PACKAGES_FILE="${BASE_DIR}/Packages"
          
          cd "${PKG_DIR}" || { echo "Failed to cd to ${PKG_DIR}"; exit 1; }
          
          rm -f "../../Packages" "../../Packages.gz" 2>/dev/null
          
          : > "../../Packages"
          
          find . -type f -name '*.ipk' -print0 | sort -z | while IFS= read -r -d '' pkg; do
            filename="${pkg#./}"
            size=$(stat -c %s "$pkg" 2>/dev/null || echo 0)
            md5=$(md5sum "$pkg" 2>/dev/null | cut -d ' ' -f1 || echo "00000000000000000000000000000000")
            sha256=$(sha256sum "$pkg" 2>/dev/null | cut -d ' ' -f1 || echo "0000000000000000000000000000000000000000000000000000000000000000")
            
            control=""
            control=$(tar -xOf "$pkg" ./control.tar.gz 2>/dev/null | zcat | tar -xOf - ./control 2>/dev/null)
            if [ -z "$control" ]; then
              control=$(tar --wildcards -xOf "$pkg" '*control*' 2>/dev/null)
            fi
            
            if [ -n "$control" ]; then
              printf '%s\n' "$control"
              printf 'Filename: %s\n' "$filename"
              printf 'Size: %s\n' "$size"
              printf 'MD5Sum: %s\n' "$md5"
              printf 'SHA256sum: %s\n' "$sha256"
              printf '\n'
            else
              echo "Warning: No control in $pkg" >&2
            fi
          done >> "../../Packages"
          
          if [ -s "../../Packages" ]; then
            gzip -9 -c "../../Packages" > "../../Packages.gz"
            echo "Packages generated with $(wc -l < "../../Packages") lines"
          else
            echo "Packages file is empty"
          fi

      - name: Debug final structure
        run: |
          echo "Root level files:"
          ls -la | grep -v '^total' || true
          echo -e "\nInside irpasswall2_repo:"
          find irpasswall2_repo -maxdepth 3 -type f | sort || true
          echo -e "\nPackages file exists? $( [ -f irpasswall2_repo/Packages ] && echo Yes || echo No )"
          head -n 20 irpasswall2_repo/Packages || echo "(empty or not found)"

      - name: Commit
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add "${{ env.BASE_DIR }}" Packages* assets_list.tsv rel.json || true
          if ! git diff --staged --quiet; then
            git commit -m "Mirror ${{ env.VERSION }} - fixed Packages path"
            git push
          else
            echo "No new changes"
          fi