name: Mirror Passwall2

on:
  schedule:
    - cron: '30 4 * * *'
  workflow_dispatch:

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: sudo apt-get update -qq && sudo apt-get install -y jq unzip curl coreutils libarchive-tools gzip

      - name: Fetch release metadata
        run: |
          curl -sSf -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/Openwrt-Passwall/openwrt-passwall2/releases/latest > rel.json
          
          tag=$(jq -r .tag_name rel.json || echo "unknown")
          echo "VERSION=$tag" >> $GITHUB_ENV
          echo "VER_FOLDER=v$tag" >> $GITHUB_ENV
          echo "BASE_DIR=irpasswall2_repo" >> $GITHUB_ENV

      - name: Prepare directory structure
        run: |
          mkdir -p "${{ env.BASE_DIR }}"
          # Clean old versions (only keep last 2)
          cd "${{ env.BASE_DIR }}" || exit 1
          ls -d v* 2>/dev/null | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+' | sort -V | head -n -2 | xargs rm -rfv || true
          cd - >/dev/null

      - name: Extract asset list
        run: |
          jq -r '
            .assets[]
            | select(.name | test("Source code"; "i") | not)
            | [.name, .browser_download_url]
            | @tsv
          ' rel.json > assets_list.tsv
          
          # برای debug: محتوای فایل را نشان بده
          echo "Assets list created. Line count: $(wc -l < assets_list.tsv)"
          head -n 10 assets_list.tsv || true

      - name: Download and organize files
        run: |
          BASE_DIR="${{ env.BASE_DIR }}"
          VER_DIR="${BASE_DIR}/${{ env.VER_FOLDER }}"
          PKG_DIR="${VER_DIR}/packages"
          
          mkdir -p "$PKG_DIR"
          
          cd "$PKG_DIR"
          
          while IFS=$'\t' read -r fname url; do
            [ -z "$fname" ] && continue
            
            echo "Processing: $fname"
            
            if [[ "$fname" == *.zip ]]; then
              # استخراج معماری از نام زیپ (apk یا ipk)
              if [[ $fname =~ passwall_packages_(apk|ipk)_([a-zA-Z0-9_-]+)\.zip ]]; then
                arch="${BASH_REMATCH[2]}"
              else
                arch="unknown_$(basename "$fname" .zip)"
              fi
              
              mkdir -p "$arch"
              
              curl -L --fail -sS -o tmp.zip "$url" || { echo "curl failed for $fname"; continue; }
              
              unzip -q -o tmp.zip -d tmp_extract || { echo "unzip failed"; rm -f tmp.zip; continue; }
              
              # انتقال ipk و apk (حتی اگر نامشان all باشد)
              find tmp_extract -type f \( -name "*.ipk" -o -name "*.apk" \) -exec mv -t "$arch" {} + 2>/dev/null || echo "No files moved from $fname"
              
              rm -rf tmp.zip tmp_extract
            elif [[ "$fname" == *.ipk || "$fname" == *.apk ]]; then
              arch="all"
              mkdir -p "$arch"
              curl -L --fail -sS -o "$arch/$fname" "$url" || echo "Download failed: $fname"
            fi
          done < ../../assets_list.tsv   # ← از ریشه repo می‌خواند (نه از BASE)

      - name: Copy all to other arches
        run: |
          cd "${{ env.BASE_DIR }}/${{ env.VER_FOLDER }}/packages" || exit 1
          
          if [ -d all ] && ls all/*.ipk all/*.apk >/dev/null 2>&1; then
            for arch in */ ; do
              [ "$arch" = "all/" ] && continue
              cp -f all/* "$arch" 2>/dev/null || true
            done
          fi

      - name: Generate opkg Packages index
        run: |
          cd "${{ env.BASE_DIR }}/${{ env.VER_FOLDER }}/packages" || exit 1
          
          > "${{ env.BASE_DIR }}/Packages"
          
          find . -type f -name '*.ipk' -print0 | sort -z | while IFS= read -r -d '' pkg; do
            filename="${pkg#./}"
            [ -z "$filename" ] && continue
            
            size=$(stat -c%s "$pkg" 2>/dev/null || echo 0)
            md5=$(md5sum "$pkg" 2>/dev/null | cut -d' ' -f1 || echo "00000000000000000000000000000000")
            sha256=$(sha256sum "$pkg" 2>/dev/null | cut -d' ' -f1 || echo "0000000000000000000000000000000000000000000000000000000000000000")
            
            control=$( (tar -xOf "$pkg" ./control.tar.gz 2>/dev/null | zcat | tar -xOf - ./control) || \
                       tar --wildcards -xOf "$pkg" '*control' 2>/dev/null || echo "" )
            
            if [ -n "$control" ]; then
              echo "$control"
              echo "Filename: $filename"
              echo "Size: $size"
              echo "MD5Sum: $md5"
              echo "SHA256sum: $sha256"
              echo ""
            fi
          done >> "${{ env.BASE_DIR }}/Packages"
          
          gzip -9 -c "${{ env.BASE_DIR }}/Packages" > "${{ env.BASE_DIR }}/Packages.gz"

      - name: Debug - list structure
        run: |
          echo "Root files:"
          ls -la | grep -v '^total'
          echo -e "\nInside irpasswall2_repo:"
          tree -L 3 "${{ env.BASE_DIR }}" || find "${{ env.BASE_DIR }}" -maxdepth 3 -print | sort

      - name: Commit changes
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          git add "${{ env.BASE_DIR }}" Packages* assets_list.tsv rel.json || true
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Mirror update: ${{ env.VERSION }} (fixed paths)"
            git push
          fi