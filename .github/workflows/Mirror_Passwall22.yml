name: Mirror Passwall2.2

on:
  schedule:
    - cron: '0 5 * * *'
  workflow_dispatch:

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install deps
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y jq unzip curl coreutils libarchive-tools gzip

      - name: Get latest release tag (safe method without API rate limit)
        run: |
          LATEST_TAG=$(curl -s -L -w "%{url_effective}" -o /dev/null https://github.com/Openwrt-Passwall/openwrt-passwall2/releases/latest | sed 's|.*/||')
          echo "VERSION=$LATEST_TAG" >> $GITHUB_ENV
          echo "VER_FOLDER=v$LATEST_TAG" >> $GITHUB_ENV
          echo "BASE_DIR=irpasswall2_repo" >> $GITHUB_ENV
          echo "Latest detected version: $LATEST_TAG"

      - name: Clean old versions (keep last 2)
        run: |
          mkdir -p "${{ env.BASE_DIR }}"
          cd "${{ env.BASE_DIR }}"
          ls -d v* 2>/dev/null | grep -E '^v[0-9]+\.[0-9]+' | sort -V | head -n -2 | xargs rm -rfv || true
          cd -

      - name: Download & organize
        run: |
          BASE="${{ env.BASE_DIR }}"
          TARGET="${BASE}/${{ env.VER_FOLDER }}/packages"
          mkdir -p "$TARGET"
          
          # لیست assetها رو مستقیم از صفحه latest می‌گیریم (بدون API)
          curl -s https://github.com/Openwrt-Passwall/openwrt-passwall2/releases/download/${{ env.VERSION }} | grep -oP 'href="\K[^"]+\.(apk|ipk|zip)' | sed 's|^|https://github.com/Openwrt-Passwall/openwrt-passwall2/releases/download/${{ env.VERSION }}/|' > assets_urls.txt
          
          while IFS= read -r URL; do
            NAME=$(basename "$URL")
            echo "→ $NAME"
            
            if [[ "$NAME" == *.ipk || "$NAME" == *.apk ]]; then
              arch="all"
              if [[ "$NAME" =~ _([a-z0-9_-]+)\.(ipk|apk)$ ]]; then
                arch="${BASH_REMATCH[1]}"
              fi
              mkdir -p "$TARGET/$arch"
              curl -L --fail -sS -o "$TARGET/$arch/$NAME" "$URL" || echo "Failed: $NAME"
            fi
            
            if [[ "$NAME" =~ passwall_packages_(apk|ipk)_(.+)\.zip ]]; then
              pkg_type="${BASH_REMATCH[1]}"
              arch_full="${BASH_REMATCH[2]}"
              mkdir -p "$TARGET/$arch_full"
              
              curl -L --fail -sS -o temp.zip "$URL" || continue
              unzip -q -o temp.zip -d temp_extract || { rm -f temp.zip; continue; }
              
              find temp_extract -type f \( -name '*.ipk' -o -name '*.apk' \) -exec mv {} "$TARGET/$arch_full/" \;
              
              rm -rf temp.zip temp_extract
              echo "Extracted $NAME → $arch_full"
            fi
          done < assets_urls.txt

          cd "$TARGET" || exit 1
          if [ -d all ] && ls all/*.{ipk,apk} >/dev/null 2>&1; then
            for d in */ ; do
              [[ $d == all/ ]] && continue
              cp -f all/* "$d" 2>/dev/null
            done
          fi

      # بقیه مراحل (Generate Packages, Debug, Commit) همان کد قبلی باقی می‌ماند
      # برای صرفه‌جویی در فضا، فقط بخش‌های تغییر یافته را نشان دادم. بخش‌های Generate Packages و Commit را از کد قبلی کپی کن.