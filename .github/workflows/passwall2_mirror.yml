name: Sync Latest OpenWrt-Passwall2 Release

on:
  schedule:
    - cron: '0 0 * * *'  # Run daily at midnight UTC
  workflow_dispatch:  # Allow manual trigger

jobs:
  sync-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq unzip curl

      - name: Get latest release info
        id: get-release
        run: |
          RELEASE_INFO=$(curl -s https://api.github.com/repos/Openwrt-Passwall/openwrt-passwall2/releases/latest)
          VERSION=$(echo "$RELEASE_INFO" | jq -r '.tag_name')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          ASSETS=$(echo "$RELEASE_INFO" | jq -r '.assets[] | {name: .name, browser_download_url: .browser_download_url}')
          echo "ASSETS=$ASSETS" >> $GITHUB_ENV

      - name: Create version folder
        run: mkdir -p "${{ env.VERSION }}"

      - name: Download and process assets
        run: |
          ASSETS_JSON='${{ env.ASSETS }}'
          echo "$ASSETS_JSON" | jq -c '.' | while read -r ASSET; do
            NAME=$(echo "$ASSET" | jq -r '.name')
            URL=$(echo "$ASSET" | jq -r '.browser_download_url')
            
            if [[ "$NAME" == *.apk || "$NAME" == *.ipk ]]; then
              # Download and copy directly to version folder
              curl -L -o "${{ env.VERSION }}/$NAME" "$URL"
            elif [[ "$NAME" == *.zip ]]; then
              # Download zip
              curl -L -o "$NAME" "$URL"
              # Extract zip
              unzip -o "$NAME" -d temp_extract
              # Parse architecture from name, e.g., passwall_packages_apk_aarch64_cortex-a53.zip -> aarch64/cortex-a53
              ARCH=$(echo "$NAME" | sed -E 's/passwall_packages_apk_([a-z0-9-]+)_([a-z0-9-]+)\.zip/\1/')
              SUBARCH=$(echo "$NAME" | sed -E 's/passwall_packages_apk_([a-z0-9-]+)_([a-z0-9-]+)\.zip/\2/')
              if [ -z "$SUBARCH" ]; then
                SUBARCH=""  # If no subarch, just use arch
              else
                SUBARCH="/$SUBARCH"
              fi
              # Create subfolder
              mkdir -p "${{ env.VERSION }}/$ARCH$SUBARCH"
              # Move extracted files to subfolder
              mv temp_extract/* "${{ env.VERSION }}/$ARCH$SUBARCH/" || true
              rm -rf temp_extract
              rm "$NAME"
            fi
          done

      - name: Commit and push changes
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add .
          git commit -m "Sync latest release: ${{ env.VERSION }}" || echo "No changes to commit"
          git push