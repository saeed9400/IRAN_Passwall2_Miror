name: Sync Latest OpenWrt-Passwall2 Release to IR_Passwall2

on:
  schedule:
    - cron: '0 0 * * *'   # روزانه
  workflow_dispatch:

jobs:
  sync-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq unzip curl

      - name: Get latest release info
        id: get-release
        run: |
          RELEASE_JSON=$(curl -s https://api.github.com/repos/Openwrt-Passwall/openwrt-passwall2/releases/latest)
          
          VERSION=$(echo "$RELEASE_JSON" | jq -r '.tag_name')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          
          # فقط assetهایی که منبع کد نیستند
          ASSETS=$(echo "$RELEASE_JSON" | jq -r '.assets[] | select(.name | test("Source code") | not) | {name: .name, browser_download_url: .browser_download_url}')
          echo "$ASSETS" > assets.json

      - name: Create version folder inside IR_Passwall2
        run: |
          mkdir -p "IR_Passwall2/${{ env.VERSION }}"

      - name: Download and organize assets
        run: |
          TARGET_DIR="IR_Passwall2/${{ env.VERSION }}"
          
          jq -c '.[]' assets.json | while read -r ASSET; do
            NAME=$(echo "$ASSET" | jq -r '.name')
            URL=$(echo "$ASSET" | jq -r '.browser_download_url')
            
            # فایل‌های apk و ipk → مستقیم در پوشه نسخه
            if [[ "$NAME" == *.apk || "$NAME" == *.ipk ]]; then
              curl -L -o "$TARGET_DIR/$NAME" "$URL"
              echo "Copied: $NAME → $TARGET_DIR/"
            fi
            
            # فایل‌های zip (پکیج‌ها) → استخراج و مرتب‌سازی در زیرپوشه معماری
            if [[ "$NAME" == passwall_packages_apk_*.zip ]]; then
              # دانلود
              curl -L -o temp.zip "$URL"
              
              # استخراج
              unzip -o temp.zip -d temp_extract
              
              # تشخیص معماری و زیرمعماری از نام فایل زیپ
              # مثال: passwall_packages_apk_aarch64_cortex-a72.zip
              ARCH=$(echo "$NAME" | sed -E 's/.*_apk_([^_]+)_?.*/\1/')
              SUBARCH=$(echo "$NAME" | sed -E 's/.*_apk_[^_]+_([^.]+)\.zip/\1/' || echo "")
              
              # اگر زیرمعماری پیدا نشد → فقط معماری
              if [[ "$SUBARCH" == "$NAME" || -z "$SUBARCH" ]]; then
                DEST="$TARGET_DIR/$ARCH"
              else
                DEST="$TARGET_DIR/$ARCH/$SUBARCH"
              fi
              
              mkdir -p "$DEST"
              
              # انتقال فایل‌های استخراج‌شده
              mv temp_extract/* "$DEST/" 2>/dev/null || true
              
              # پاکسازی
              rm -rf temp_extract temp.zip
              
              echo "Extracted $NAME → $DEST/"
            fi
          done

      - name: Commit and push if changed
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          git add IR_Passwall2/
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Sync latest release: ${{ env.VERSION }}"
            git push
          fi